<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Isabella Bitetto (Fondazione COISPA)">

<title>SEAwise – Fish price &amp; Variable costs</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<!-- Load Font Awesome for social icons -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>

#header-links {

  margin: 1rem 0;

  display: flex;

  gap: 0.6rem;

}



#header-links a {

  display: inline-flex;

  align-items: center;

  padding: 0.4em 0.8em;

  border: 1px solid #ccc;

  border-radius: 5px;

  text-decoration: none;

  color: #333;

  background: #fff;

  font-size: 0.95em;

  transition: all 0.2s;

}



#header-links a:hover {

  background: #f5f5f5;

}



#header-links img {

  margin-right: 6px;

}

</style>

<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>

<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">

<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles-quarto.css">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./pics/SeaWiseFinal-01.png" alt="" class="navbar-logo">
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./Enhanced_fishprice_fuelcosts_submodels.html" aria-current="page"> 
<span class="menu-text">SEAwise – Fish price &amp; Variable costs</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://seawiseproject.org/"> 
<span class="menu-text">SEAwise Website</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/ices-tools-dev/SEAwise"> 
<span class="menu-text">SEAwise Github</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">Index</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#adriatic-and-western-ionian-sea-case-study---background" id="toc-adriatic-and-western-ionian-sea-case-study---background" class="nav-link" data-scroll-target="#adriatic-and-western-ionian-sea-case-study---background">Adriatic and western Ionian Sea case study - background</a></li>
  <li><a href="#fish-price" id="toc-fish-price" class="nav-link" data-scroll-target="#fish-price">Fish price</a>
  <ul>
  <li><a href="#data-structure" id="toc-data-structure" class="nav-link" data-scroll-target="#data-structure">Data structure</a></li>
  <li><a href="#fish-price-sub-models" id="toc-fish-price-sub-models" class="nav-link" data-scroll-target="#fish-price-sub-models">Fish price sub-models</a></li>
  <li><a href="#models-fitting" id="toc-models-fitting" class="nav-link" data-scroll-target="#models-fitting">Models fitting</a></li>
  </ul></li>
  <li><a href="#variable-costs" id="toc-variable-costs" class="nav-link" data-scroll-target="#variable-costs">Variable costs</a></li>
  <li><a href="#suggestions-for-the-model-selection" id="toc-suggestions-for-the-model-selection" class="nav-link" data-scroll-target="#suggestions-for-the-model-selection">Suggestions for the model selection</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">SEAwise – Fish price &amp; Variable costs</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Isabella Bitetto (Fondazione COISPA) </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Compiled on 29/08/2025, 14:12</code></pre>
</div>
</div>
<!-- Logo in the title -->
<style>
/* Make the title line a flex row with the logo on the left */
.title-with-logo {
  display: flex;
  align-items: center;
  gap: 14px;              /* spacing between logo and text */
  margin-top: 0.5rem;
  margin-bottom: 1rem;
}
.title-with-logo img {
  width: 120px;           /* adjust logo size as needed */
  height: auto;
}
</style>
<script>
// Wrap the H1.title with a container and prepend the logo to its left
document.addEventListener("DOMContentLoaded", function(){
  // find the auto-generated title element
  var h1 = document.querySelector("h1.title");
  if(!h1) return;

  // create wrapper
  var wrap = document.createElement("div");
  wrap.className = "title-with-logo";

  // create logo
  var img = document.createElement("img");
  img.src = "pics/SeaWiseFinal-01.png";   // relative path from Rmd root
  img.alt = "SEAwise logo";

  // insert: wrap replaces h1, then put logo + h1 inside wrap
  h1.parentNode.insertBefore(wrap, h1);
  wrap.appendChild(img);
  wrap.appendChild(h1);
});
</script>
<!-- Links -->
<div id="header-links">
<p><a href="https://seawiseproject.org/" target="_blank"> <img src="seawise_logo_fullcolour.png" width="20" height="22" style="margin-right:6px; vertical-align:middle;"> SEAwise Website </a> <a href="https://github.com/ices-tools-dev/SEAwise&quot;" target="_blank"> <img src="github.svg" width="20" height="22" style="margin-right:6px; vertical-align:middle;"> SEAwise Github </a></p>
</div>
<!-- start of the script -->
<section id="introduction" class="level2 tabset">
<h2 class="tabset anchored" data-anchor-id="introduction">Introduction</h2>
<p>This tutorial is based on the work carried out within SEAwise – Work Package 2: Social and economic effects of and on fishing.</p>
<p>Within SEAwise (seawiseproject.org), the socio-economic impacts of a set of management measures were investigated and quantified using bio-economic modelling. The project developed methodologies to strengthen the economic sub-models integrated into bio-economic models for Ecosystem-Based Fisheries Management (EBFM). This is crucial to ensure that the effects of management measures on the economic performance of fishing fleets are properly assessed and communicated to decision-makers, supporting more informed policy choices.</p>
<p>In particular, SEAwise improved the configuration of the economic component by adopting more flexible sub-models—moving beyond the common assumptions of fixed fuel costs and fixed fish prices—in order to produce more realistic fleet performance projections.</p>
<p>This document presents an example of how different equations for fish prices and variable costs can be fitted, using the case study of demersal fisheries in the Adriatic and Western Ionian Seas.</p>
<p>The tutorial is structured in two parts: the first focuses on fish price modelling, while the second addresses variable costs.</p>
</section>
<section id="adriatic-and-western-ionian-sea-case-study---background" class="level2">
<h2 class="anchored" data-anchor-id="adriatic-and-western-ionian-sea-case-study---background">Adriatic and western Ionian Sea case study - background</h2>
<p>Here is the map of the study area:</p>
<p align="center">
<img src="map.png" width="70%">
</p>
<p>In SEAwise the main enhancement is represented by the disaggregation of the trawlers fleet segments by fishing activity at metier level (demersal: OTB_DEF, deep-water: OTB_DWS and mixed: OTB_MDD) in order to model possible effort re-allocation due to the implementation of the management measures (e.g.&nbsp;red shrimps catch limits) and/or to different fishing strategies as response to management (e.g.&nbsp;behavioural component).</p>
<p>The activity of the trawlers fleet segments in GSA 18 and 19 were split according to (<a href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0264334">Bitetto et al.(2022)</a> using the FDI effort data in the among three metier: demersal species (OTB_DEF), deep-water species (OTB_DWS) and mixed species (OTB_MDD) (Table 1). In GSA 17 the activity was not split by metier because only OTB_DEF is applied.</p>
<div style="text-align:center; font-weight:600; margin-bottom:0.5rem;">
<p>Table 1- Fleet segment-metier combinations considered for the split of the fishing activity in the Adriatic and western Ionian Sea case study</p>
</div>
<table class="table table-striped table-bordered caption-top" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">FS</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Metier</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">GSA_18_DTS_0612</td>
<td style="text-align: left;">OTB_DES</td>
</tr>
<tr class="even">
<td rowspan="2" style="text-align: left; vertical-align: top !important;">GSA_18_DTS_1218</td>
<td style="text-align: left;">OTB_DES</td>
</tr>
<tr class="odd">
<td style="text-align: left;">OTB_DWS_MDD</td>
</tr>
<tr class="even">
<td rowspan="2" style="text-align: left; vertical-align: top !important;">GSA_18_DTS_1840</td>
<td style="text-align: left;">OTB_DES</td>
</tr>
<tr class="odd">
<td style="text-align: left;">OTB_DWS_MDD</td>
</tr>
<tr class="even">
<td style="text-align: left;">GSA_19_DTS_0612</td>
<td style="text-align: left;">OTB_DES</td>
</tr>
<tr class="odd">
<td rowspan="2" style="text-align: left; vertical-align: top !important;">GSA_19_DTS_1218</td>
<td style="text-align: left;">OTB_DES</td>
</tr>
<tr class="even">
<td style="text-align: left;">OTB_DWS_MDD</td>
</tr>
<tr class="odd">
<td rowspan="2" style="text-align: left; vertical-align: top !important;">GSA_19_DTS_1840</td>
<td style="text-align: left;">OTB_DES</td>
</tr>
<tr class="even">
<td style="text-align: left;">OTB_DWS_MDD</td>
</tr>
</tbody>
</table>


<p>The models were also enhanced for the other fleet segments (not split by metier) modelled in BEMTOOL, that are listed in Table 2.</p>
<div style="text-align:center; font-weight:600; margin-bottom:0.5rem;">
<p>Table 2- fleet segment enhanced not by metier. HRV stands for Croatia, SVN stands for Slovenia, ITA for Italy. DFN are fixed nets, DTS are vessels using as main gear trawl, PGP are polyvalent, HOK are vessels using hooks.</p>
</div>
<table class="table table-striped table-bordered caption-top" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Fleet_segments</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">HRV_17_DFN_0612</td>
</tr>
<tr class="even">
<td style="text-align: left;">HRV_17_DTS_0612</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HRV_17_DTS_1218</td>
</tr>
<tr class="even">
<td style="text-align: left;">HRV_17_DTS_1840</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ITA_17_DTS_0612</td>
</tr>
<tr class="even">
<td style="text-align: left;">ITA_17_DTS_1218</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ITA_17_DTS_1840</td>
</tr>
<tr class="even">
<td style="text-align: left;">ITA_17_PGP_0012</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ITA_18_DTS_0612</td>
</tr>
<tr class="even">
<td style="text-align: left;">ITA_18_HOK_1218</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ITA_18_PGP_0012</td>
</tr>
<tr class="even">
<td style="text-align: left;">ITA_19_HOK_0624</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ITA_19_PGP_0006</td>
</tr>
<tr class="even">
<td style="text-align: left;">ITA_19_PGP_0612</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ITA_19_PGP_1218</td>
</tr>
<tr class="even">
<td style="text-align: left;">SVN_17_DTS_1218</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ITA_17_TBB_VL1218</td>
</tr>
<tr class="even">
<td style="text-align: left;">ITA_17_TBB_VL1840</td>
</tr>
</tbody>
</table>


</section>
<section id="fish-price" class="level2">
<h2 class="anchored" data-anchor-id="fish-price">Fish price</h2>
<section id="data-structure" class="level3">
<h3 class="anchored" data-anchor-id="data-structure">Data structure</h3>
<p>In this tutorial a dummy dataset is provided, to show the structure that your data needs to respect to run the fish price tutorial, available in SEAwise repository (task 2.2, CentralMed zip file). The revenues by species data are categorized as Variable “revenues.landing”, while the corresponding landing as “landing.weight”.</p>
<p>In the code the number of iterations refers to the k-fold used to derive the RMSE.</p>
<div class="cell">
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Fleet_segment"],"name":[1],"type":["chr"],"align":["left"]},{"label":["Species"],"name":[2],"type":["chr"],"align":["left"]},{"label":["Year"],"name":[3],"type":["int"],"align":["right"]},{"label":["Variable"],"name":[4],"type":["chr"],"align":["left"]},{"label":["Value"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"ITA_18_DTS_1218_OTB_DWS_MDD","2":"ARA181920","3":"2014","4":"revenues.landing","5":"8.446688e+04","_rn_":"34"},{"1":"ITA_18_DTS_1218_OTB_DWS_MDD","2":"ARS181920","3":"2013","4":"revenues.landing","5":"2.790210e-02","_rn_":"39"},{"1":"ITA_18_DTS_1218_OTB_DWS_MDD","2":"ARS181920","3":"2014","4":"revenues.landing","5":"8.446688e+04","_rn_":"42"},{"1":"ITA_18_DTS_1218_OTB_DES","2":"HKE1718","3":"2013","4":"revenues.landing","5":"9.088955e+06","_rn_":"86"},{"1":"ITA_18_DTS_1218_OTB_DES","2":"MUT1718","3":"2013","4":"revenues.landing","5":"3.864743e+06","_rn_":"88"},{"1":"ITA_18_DTS_1218_OTB_DES","2":"DPS171819","3":"2013","4":"revenues.landing","5":"3.150100e+06","_rn_":"89"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="fish-price-sub-models" class="level3">
<h3 class="anchored" data-anchor-id="fish-price-sub-models">Fish price sub-models</h3>
<p>For the Adriatic and western Ionian Sea case study, an exploration of different price models were carried out on European hake, red mullet, deep-water rose shrimp, giant red shrimp and blue and red shrimp in GSAs 18 and 19. Specifically, for the 9 combinations fleet segment-metier,5 different models among the ones reported in Deiverable 2.2 (<a href="https://data.dtu.dk/articles/online_resource/SEAwise_report_on_Carbon_footprint_economic_and_social_impacts_of_management_strategies/25012085">Bitetto et al., 2023 – SEAwise Report on Carbon footprint, economic and social impacts of management strategies</a> ) were explored and compared through the RMSE to select the best one.</p>
<p>The equations tested in this tutorial follow:</p>
<p>Model 1 assumes that fish price depends on relative changes in landings:</p>
<p><span class="math display">\[
p_{s,f,t}
= p_{s,f,t-1}\left(1+\varepsilon_{s,f}\frac{L_{s,f,t}-L_{s,f,t-1}}{L_{s,f,t-1}}\right)
\]</span></p>
<p>where <span class="math inline">\(\varepsilon_{s,f}\)</span> is the elasticity coefficient of price with respect to landings.</p>
<p>Model 2 assumes that price as a function of the ratio between current landings and landings of the previous year, modified with respect to <a href="https://research.wur.nl/en/publications/fishrent-bio-economic-simulation-and-optimisation-model">Salz et al., 2011 – FISHRENT; Bio-economic simulation and optimisation model</a>:</p>
<p><span class="math display">\[
p_{s,f,t} = p_{s,f,t-1}\left(\frac{L_{s,f,t}}{L_{s,f,t-1}}\right)^{\varepsilon_{s,f}}
\]</span> In the original version of Salz et al., (2011) the ratio was against base year of the previous year.</p>
<p>Model 3 assumes that price as a function of the current landings.</p>
<p><span class="math display">\[
p_{s,f,t} = p_{s,f,t=last} \; e^{\varepsilon_{s,f} \, L_{s,f,t}}
\]</span> where <span class="math inline">\(p_{s,f,t=last}\)</span> is the price in the last year (€/kg) and <span class="math inline">\(\varepsilon_{s,f}\)</span> is the elasticity coefficient of price with respect to landings.</p>
<p>Model 4 assumes an average constant price, while Model 5 follows the price–landings elasticity formulation as described in Kraak et al.&nbsp;(2004) and implemented in the FLBEIA toolbox (<a href="https://flr-project.org/doc/FLBEIA_An_Example_with_multiple_dimensions.html">FLBEIA price dynamics function documentation by Garcia et al.&nbsp;(2012)</a>). The model increases prices when landings decline (and decreases them when landings rise), with the option to base calculations on total landings rather than fleet-specific landings. For this case study the price is assumed independent of age.</p>
<p><span class="math display">\[
p_{a,t,f,\text{season}}
= p_{a,0,f,\text{season}}
\left(\frac{L_{a,0,f,\text{season}}}{L_{a,t,f,\text{season}}}\right)^{\varepsilon_{a,f,\text{season}}}
\]</span></p>
</section>
<section id="models-fitting" class="level3">
<h3 class="anchored" data-anchor-id="models-fitting">Models fitting</h3>
<p>The script price_sub_models_Adriatic_Ionian.r until line 333 fits the 5 models above described for each combination fleet segment-metier. The analysis is carried out by species and the results are automatically saved and stored in the directory FishPrice created by the script in the working directory.</p>
<p>For each model the RMSE (predictive capability) is also estimated, applying the k-fold approach (<span class="math inline">\(k=6\)</span>), fitting the model on five-sixths of the dataset and validating on the remaining one-sixth:</p>
<p><span class="math display">\[
RMSE = \sqrt{\frac{SSE}{N} + MAE^2}
\]</span></p>
<p>The RMSE and model coefficients were estimated over 30 iterations (the number can be modified on the top of the script) to mitigate bias caused by the limited length of the available time series. The final RMSE is calculated as the average across all iterations.</p>
<p>Once that the 5 models have been fit, a number of outcomes are automatically saved and available to select the best model for each fleet segment-metier:</p>
<ul>
<li>a summary of the elasticity coefficients and RMSE for each fleet segment-metier and for the 5 models;</li>
</ul>
<table class="table table-striped table-bordered caption-top" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">epsilon</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">FS</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">SPECIES</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">MODEL</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">RMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">-0.21080</td>
<td style="text-align: left;">HRV_17_DFN_0612</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">0.3128020</td>
</tr>
<tr class="even">
<td style="text-align: left;">0.02274</td>
<td style="text-align: left;">HRV_17_DTS_0612</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">0.1454150</td>
</tr>
<tr class="odd">
<td style="text-align: left;">-0.20261</td>
<td style="text-align: left;">HRV_17_DTS_1218</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">0.2601498</td>
</tr>
<tr class="even">
<td style="text-align: left;">-0.04681</td>
<td style="text-align: left;">HRV_17_DTS_1840</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">0.4440918</td>
</tr>
<tr class="odd">
<td style="text-align: left;">-0.87599</td>
<td style="text-align: left;">ITA_17_DTS_0612</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">71.2518653</td>
</tr>
<tr class="even">
<td style="text-align: left;">-0.46268</td>
<td style="text-align: left;">ITA_17_DTS_1218</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">0.5651157</td>
</tr>
</tbody>
</table>


<ul>
<li>a summary of the observed and estimated prices for each year, fleet segment-metier and for the 5 models;</li>
</ul>
<table class="table table-striped table-bordered caption-top" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Fleet_segment</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Species</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Year</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Revenues</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Landing</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">price</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">price_Mod1</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">price_Mod2</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">price_Mod3</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">price_Mod4</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">price_Mod5</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="6" style="text-align: left; vertical-align: top !important;">HRV_17_DFN_0612</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">2013</td>
<td style="text-align: left;">361196.9</td>
<td style="text-align: left;">122000</td>
<td style="text-align: left;">2.960631</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">3.429208</td>
<td style="text-align: left;">2.960631</td>
</tr>
<tr class="even">
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">2014</td>
<td style="text-align: left;">418159.1</td>
<td style="text-align: left;">118000</td>
<td style="text-align: left;">3.543722</td>
<td style="text-align: left;">2.979778</td>
<td style="text-align: left;">2.976051</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">3.429208</td>
<td style="text-align: left;">3.087963</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">2015</td>
<td style="text-align: left;">391624.0</td>
<td style="text-align: left;">114000</td>
<td style="text-align: left;">3.435298</td>
<td style="text-align: left;">3.567445</td>
<td style="text-align: left;">3.562817</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">3.429208</td>
<td style="text-align: left;">3.225453</td>
</tr>
<tr class="even">
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">2016</td>
<td style="text-align: left;">578728.8</td>
<td style="text-align: left;">163000</td>
<td style="text-align: left;">3.550483</td>
<td style="text-align: left;">3.238269</td>
<td style="text-align: left;">3.249123</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">3.429208</td>
<td style="text-align: left;">2.053254</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">2017</td>
<td style="text-align: left;">522136.9</td>
<td style="text-align: left;">139000</td>
<td style="text-align: left;">3.756381</td>
<td style="text-align: left;">3.667444</td>
<td style="text-align: left;">3.639711</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">3.429208</td>
<td style="text-align: left;">2.510843</td>
</tr>
<tr class="even">
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">2018</td>
<td style="text-align: left;">677331.2</td>
<td style="text-align: left;">171000</td>
<td style="text-align: left;">3.961001</td>
<td style="text-align: left;">3.622264</td>
<td style="text-align: left;">3.637035</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">3.429208</td>
<td style="text-align: left;">1.932672</td>
</tr>
</tbody>
</table>


<ul>
<li>the models with the lower RMSE for each fleet segment-metier;</li>
</ul>
<table class="table table-striped table-bordered caption-top" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">epsilon</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">FS</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">SPECIES</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">MODEL</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">RMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">-0.2108000</td>
<td style="text-align: left;">HRV_17_DFN_0612</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">0.3128020</td>
</tr>
<tr class="even">
<td style="text-align: left;">0.0000002</td>
<td style="text-align: left;">HRV_17_DTS_0612</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">0.1198211</td>
</tr>
<tr class="odd">
<td style="text-align: left;">0.2040000</td>
<td style="text-align: left;">HRV_17_DTS_1218</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;">0.1772077</td>
</tr>
<tr class="even">
<td style="text-align: left;">0.0000002</td>
<td style="text-align: left;">HRV_17_DTS_1840</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">0.3036465</td>
</tr>
<tr class="odd">
<td style="text-align: left;">0.3570000</td>
<td style="text-align: left;">ITA_17_DTS_0612</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;">20.8048173</td>
</tr>
<tr class="even">
<td style="text-align: left;">0.6250000</td>
<td style="text-align: left;">ITA_17_DTS_1218</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;">0.4627532</td>
</tr>
</tbody>
</table>


<ul>
<li>the models with the lower RMSE for each fleet segment-metier;</li>
</ul>
<table class="table table-striped table-bordered caption-top" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">epsilon</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">FS</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">SPECIES</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">MODEL</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">RMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">-0.2108000</td>
<td style="text-align: left;">HRV_17_DFN_0612</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">0.3128020</td>
</tr>
<tr class="even">
<td style="text-align: left;">0.0000002</td>
<td style="text-align: left;">HRV_17_DTS_0612</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">0.1198211</td>
</tr>
<tr class="odd">
<td style="text-align: left;">0.2040000</td>
<td style="text-align: left;">HRV_17_DTS_1218</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;">0.1772077</td>
</tr>
<tr class="even">
<td style="text-align: left;">0.0000002</td>
<td style="text-align: left;">HRV_17_DTS_1840</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">0.3036465</td>
</tr>
<tr class="odd">
<td style="text-align: left;">0.3570000</td>
<td style="text-align: left;">ITA_17_DTS_0612</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;">20.8048173</td>
</tr>
<tr class="even">
<td style="text-align: left;">0.6250000</td>
<td style="text-align: left;">ITA_17_DTS_1218</td>
<td style="text-align: left;">HKE1718</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;">0.4627532</td>
</tr>
</tbody>
</table>


<ul>
<li>for each fleet segment-metier a plot reporting the observed values by year and the 5 estimated price by the 5 models is produced.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="graph8.jpg" class="img-fluid figure-img" style="width:40.0%"></p>
<figcaption>Example of plot comparing the different models versus the observed prices</figcaption>
</figure>
</div>
</section>
</section>
<section id="variable-costs" class="level2">
<h2 class="anchored" data-anchor-id="variable-costs">Variable costs</h2>
<p>In this example is explored only model 1, based on the assumption that fuel and other variable costs depend on fishing days:</p>
<p><span class="math display">\[
\mathrm{FuC}_{f,t} = a_f \cdot \mathrm{AnnFD}_{f,t}
\]</span> where <span class="math inline">\({FuC}_{f,t}\)</span> are the fuel costs (€),<span class="math inline">\(a_f\)</span> is the fuel cost per fishing day, <span class="math inline">\({AnnFD}_{f,t}\)</span> are the total annual fishing days.</p>
<p>The script VC_sub_models_Adriatic_Ionian.r fits the model above described for each combination fleet segment-metier. The analysis is carried out by fleet segment-metier and the results are automatically saved and stored in the directory FuelCosts created by the script in the working directory.</p>
<p>Also in this case the RMSE (predictive capability) is estimated, applying the k-fold approach (<span class="math inline">\(k=6\)</span>), fitting the model on five-sixths of the dataset and validating on the remaining one-sixth.</p>
<p>Two main outcomes support the user in the definition of the enhanced sub-models and estimation of the corresponding coefficients by fleet segment-metier:</p>
<ul>
<li>a summary of the coefficient (variable cost in € per fishing day) and RMSE for each fleet segment-metier;</li>
</ul>
<table class="table table-striped table-bordered caption-top" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">coeff</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">FS</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">MODEL</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">points</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">RMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">31.81001</td>
<td style="text-align: left;">HRV_17_DFN_0612</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">8</td>
<td style="text-align: left;">158241.9</td>
</tr>
<tr class="even">
<td style="text-align: left;">90.79520</td>
<td style="text-align: left;">HRV_17_DTS_0612</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">8</td>
<td style="text-align: left;">150236.4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">181.11214</td>
<td style="text-align: left;">HRV_17_DTS_1218</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">8</td>
<td style="text-align: left;">351994.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">484.95399</td>
<td style="text-align: left;">HRV_17_DTS_1840</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">8</td>
<td style="text-align: left;">500209.1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">130.39962</td>
<td style="text-align: left;">ITA_17_DTS_0612</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">7</td>
<td style="text-align: left;">124337.9</td>
</tr>
<tr class="even">
<td style="text-align: left;">355.28167</td>
<td style="text-align: left;">ITA_17_DTS_1218</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">7</td>
<td style="text-align: left;">1181781.3</td>
</tr>
</tbody>
</table>


<ul>
<li>for each fleet segment-metier a plot reporting the observed values by year and the estimated variable cost by the model is produced.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="graph1.jpg" class="img-fluid figure-img" style="width:40.0%"></p>
<figcaption>Example of plot comparing the estimated variable costs versus the observed ones</figcaption>
</figure>
</div>
</section>
<section id="suggestions-for-the-model-selection" class="level2">
<h2 class="anchored" data-anchor-id="suggestions-for-the-model-selection">Suggestions for the model selection</h2>
<p>Based on the results obtained in the Adriatic and western Ionian Sea case study, for a number of fleet segment the best fit for fish price is obtained through elasticity models rather than with constant price (model 4, with average of the years available). Nevertheless, in some cases the elasticity coefficients are very close to 0, highlighting the weak elasticity between the price and the quantity considered in the specific model explored. In many cases the differences among the fitted price through the different models are very similar, while in other cases the best model selected according to RMSE (probably compensating positive and negative residuals) does not seem to follow completely the price dynamic. For the variable costs the results show that the fishing day number drives markedly the costs.</p>
<p>However, the scripts provided can be easily generalized to include other functions.</p>
<p>For more equations, refer to Deliverable 2.2 (<a href="https://data.dtu.dk/articles/online_resource/SEAwise_report_on_Carbon_footprint_economic_and_social_impacts_of_management_strategies/25012085">Bitetto et al., 2023 – SEAwise Report on Carbon footprint, economic and social impacts of management strategies</a> ).</p>
<div class="cell" data-layout-align="center">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="model_selection_flow_vertical.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="450"></p>
</figure>
</div>
</div>
<div class="callout-guidelines">
<div class="title">
💡 Tips for model selection
</div>
<ul>
<li>
<strong>Do not rely only on RMSE</strong>: statistical fit may compensate opposite residuals and not always capture real price dynamics.
</li>
<li>
<strong>Check the elasticity values</strong>: when coefficients are close to zero, constant-price models may be more robust.
</li>
<li>
<strong>Prefer elasticity-based models</strong> when stronger relationships between landings and prices are evident.
</li>
<li>
<strong>Balance statistical and interpretative criteria</strong>: the best model is both statistically sound and economically plausible.
</li>
<li>
<strong>Focus on recent dynamics</strong>: models should reproduce recent price behaviour, since enhanced sub-models are used for future projections.
</li>
</ul>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>